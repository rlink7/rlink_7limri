<!doctype html>
<html lang="en">

    <head>

		<!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>limri</title>
        
        <!-- CSS -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500&display=swap">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
        <link rel="stylesheet" href="../../_static/css/jquery.mCustomScrollbar.min.css">
        <link rel="stylesheet" href="../../_static/css/animate.css">
        <link rel="stylesheet" href="../../_static/css/style.css">
        <link rel="stylesheet" href="../../_static/css/jquery.mosaic.css">
        <link rel="stylesheet" href="../../_static/gallery.css">
        <link rel="stylesheet" href="../../_static/css/media-queries.css">
        <link rel="stylesheet" href="../../_static/css/pygment.css">

        <!-- Favicon and touch icons -->
        <link rel="shortcut icon" href="../../_static/ico/favicon.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../_static/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../_static/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../_static/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="../../_static/ico/apple-touch-icon-57-precomposed.png">

    </head>

    <body>

		<!-- Wrapper -->
    	<div class="wrapper">

			<!-- Sidebar -->
			<nav class="sidebar">
				
				<!-- close sidebar menu -->
				<div class="dismiss">
					<i class="fas fa-arrow-left"></i>
				</div>
				
				<div class="logo"">
					<h3><a href="../../index.html">Sidebar Menu</a></h3>
				</div>

                <!-- info setup -->
                    <p class="doc-version">
                        This documentation is for limri <strong>version 0.0.1</strong>
                    </p>
                <p class="citing">
                    If you use the software, please do not hesitate to 
                    <a &mdash; <a href="https://github.com/rlink7/rlink_7limri">
                    Report a Bug</a>.
                </p>
				
                <!-- links -->
                
                
				<ul class="list-unstyled menu-elements">
					<li class="active">
						<a href="../../index.html"><i class="fas fa-home"></i> Home</a>
					</li>
					<li>
						<a href="../../generated/installation.html"><i class="fas fa-cog"></i> Installation</a>
					</li>
					<li>
						<a href="../../auto_gallery/index.html"><i class="fas fa-eye"></i> Gallery</a>
					</li>
					<li>
						<a href="../../generated/documentation.html"><i class="fas fa-pencil-alt"></i> API documentation</a>
					</li>
					<li>
						<a href="../../generated/search.html"><i class="fas fa-search"></i> Search</a>
					</li>
					<li>
						<a href="https://joliot.cea.fr/drf/joliot/Pages/Entites_de_recherche/NeuroSpin.aspx"><i class="fas fa-external-link-alt"></i> NeuroSpin webPage</a>
					</li>
					<li>
						<a href="#otherSections" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle" role="button" aria-controls="otherSections">
							<i class="fas fa-sync"></i>Sections Shortcuts
						</a>
						<ul class="collapse list-unstyled" id="otherSections">
                            <li>LINKS</li><li><a href='https://github.com/neurospin/scripts'>scripts</a></li>
                            
                            <li>API</li>
                            <li><a href="../../generated/limri.html">limri</a></li><li><a href="../../generated/limri.norm.html">limri.norm</a></li><li><a href="../../generated/limri.workflows.html">limri.workflows</a></li>
						</ul>
					</li>
				</ul>
				
                <!-- go top page -->
				<div class="to-top">
					<a class="btn btn-primary btn-customized-3" href="#" role="button">
	                    <i class="fas fa-arrow-up"></i> Top
	                </a>
				</div>
			
                <!-- change color -->
				<div class="dark-light-buttons">
					<a class="btn btn-primary btn-customized-4 btn-customized-dark" href="#" role="button">Dark</a>
					<a class="btn btn-primary btn-customized-4 btn-customized-light" href="#" role="button">Light</a>
				</div>
			
			</nav>
			<!-- End sidebar -->
			
			<!-- Dark overlay -->
    		<div class="overlay"></div>

			<!-- Content -->
			<div class="content">
			
				<!-- open sidebar menu -->
				<a class="btn btn-primary btn-customized open-menu" href="#" role="button">
                    <i class="fas fa-align-left"></i> <span>Menu</span>
                </a>

		        <!-- Top content -->
		        <div class="top-content section-container" id="top-content">
			        <div class="container">
			            <div class="row">
                            <div class="col-md-3 section-5-box banner-logo">
                                <img alt="Logo" src="../../_static/limri.png">
                            </div>
			                <div class="col-md-7 section-5-box">
			                	<h1 class="wow fadeIn">    <p>Package that provides tools for brain Lithium MRI pre-processing.</p></h1>
			                </div>
			            </div>
			        </div>
		        </div>
                    
                    <div class="document">
                        <h1>Source code for limri.regtools</h1><div class='divider-1 wow fadeInUp'><span></span></div><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">##########################################################################</span>
<span class="c1"># NSAp - Copyright (C) CEA, 2023</span>
<span class="c1"># Distributed under the terms of the CeCILL-B license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL-B_V1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Registration tools.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nibabel</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
<span class="kn">from</span> <span class="nn">limri.color_utils</span> <span class="kn">import</span> <span class="n">print_subtitle</span><span class="p">,</span> <span class="n">print_result</span>


<div class="viewcode-block" id="flirt"><a class="viewcode-back" href="../../generated/limri.regtools.flirt.html#limri.regtools.flirt">[docs]</a><span class="k">def</span> <span class="nf">flirt</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">omat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="s2">&quot;corratio&quot;</span><span class="p">,</span>
          <span class="n">usesqform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">displayinit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">anglerep</span><span class="o">=</span><span class="s2">&quot;euler&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
          <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;trilinear&quot;</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">applyxfm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">applyisoxfm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">nosearch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wmseg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Affine registration with FSL flirt.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_file: str</span>
<span class="sd">        input volume.</span>
<span class="sd">    ref_file: str</span>
<span class="sd">        reference volume.</span>
<span class="sd">    out: str</span>
<span class="sd">        output volume</span>
<span class="sd">    omat: str, default None</span>
<span class="sd">        matrix filename - output in 4x4 ascii format.</span>
<span class="sd">    init: str, default None</span>
<span class="sd">        input 4x4 affine matrix</span>
<span class="sd">    cost: str, default &#39;corratio&#39;</span>
<span class="sd">        choose the most appropriate option: &#39;mutualinfo&#39;, &#39;corratio&#39;,</span>
<span class="sd">        &#39;normcorr&#39;, &#39;normmi&#39;, &#39;leastsq&#39;, &#39;labeldiff&#39;, &#39;bbr&#39;.</span>
<span class="sd">    usesqform: bool, default False</span>
<span class="sd">        initialise using appropriate sform or qform.</span>
<span class="sd">    displayinit: bool, default False</span>
<span class="sd">        display initial matrix.</span>
<span class="sd">    anglerep: str, default &#39;euler&#39;</span>
<span class="sd">        choose the most appropriate option: &#39;quaternion&#39;, &#39;euler&#39;.</span>
<span class="sd">    bins: int, default 256</span>
<span class="sd">        number of histogram bins</span>
<span class="sd">    interp: str, default &#39;trilinear&#39;</span>
<span class="sd">        choose the most appropriate option: &#39;trilinear&#39;, &#39;nearestneighbour&#39;,</span>
<span class="sd">        &#39;sinc&#39;, &#39;spline&#39;.</span>
<span class="sd">    dof: int, default 12</span>
<span class="sd">        number of transform dofs.</span>
<span class="sd">    applyxfm: bool, default False</span>
<span class="sd">        ppplies transform (no optimisation) - requires -init.</span>
<span class="sd">    applyisoxfm: float, default None</span>
<span class="sd">        the integer defines the scale - as applyxfm but forces isotropic</span>
<span class="sd">        resampling.</span>
<span class="sd">    verbose: int, default 0</span>
<span class="sd">        0 is least and default.</span>
<span class="sd">    nosearch: bool, default False</span>
<span class="sd">        if set perform no search to initialize the optimization.</span>
<span class="sd">    wmseg: str, default None</span>
<span class="sd">        white matter segmentation volume needed by BBR cost function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out: str</span>
<span class="sd">        output volume.</span>
<span class="sd">    omat: str</span>
<span class="sd">        output matrix filename - output in 4x4 ascii format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flirt&quot;</span><span class="p">,</span>
           <span class="s2">&quot;-in&quot;</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span>
           <span class="s2">&quot;-ref&quot;</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">,</span>
           <span class="s2">&quot;-cost&quot;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span>
           <span class="s2">&quot;-searchcost&quot;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span>
           <span class="s2">&quot;-anglerep&quot;</span><span class="p">,</span> <span class="n">anglerep</span><span class="p">,</span>
           <span class="s2">&quot;-bins&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">bins</span><span class="p">),</span>
           <span class="s2">&quot;-interp&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span>
           <span class="s2">&quot;-dof&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dof</span><span class="p">),</span>
           <span class="s2">&quot;-out&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
           <span class="s2">&quot;-verbose&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">verbose</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">usesqform</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-usesqform&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">displayinit</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-displayinit&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">applyxfm</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-applyxfm&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nosearch</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-nosearch&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-init&quot;</span><span class="p">,</span> <span class="n">init</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">applyisoxfm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-applyisoxfm&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">applyisoxfm</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">cost</span> <span class="o">==</span> <span class="s2">&quot;bbr&quot;</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-wmseg&quot;</span><span class="p">,</span> <span class="n">wmseg</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">applyxfm</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-omat&quot;</span><span class="p">,</span> <span class="n">omat</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">omat</span></div>


<div class="viewcode-block" id="applywarp"><a class="viewcode-back" href="../../generated/limri.regtools.applywarp.html#limri.regtools.applywarp">[docs]</a><span class="k">def</span> <span class="nf">applywarp</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">warp_file</span><span class="p">,</span> <span class="n">pre_affine_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">post_affine_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;trilinear&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Apply SPM deformation field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_file: str</span>
<span class="sd">        filename of input image (to be warped).</span>
<span class="sd">    ref_file: str</span>
<span class="sd">        filename for reference image.</span>
<span class="sd">    out_file: str</span>
<span class="sd">        filename for output (warped) image.</span>
<span class="sd">    warp_file: str</span>
<span class="sd">        filename for warp/coefficient (volume).</span>
<span class="sd">    pre_affine_file: str, default None</span>
<span class="sd">        filename for pre-transform (affine matrix).</span>
<span class="sd">    post_affine_file: str, default None</span>
<span class="sd">        filename for post-transform (affine matrix).</span>
<span class="sd">    interp: str, default &#39;trilinear&#39;</span>
<span class="sd">        interpolation method {nn,trilinear,sinc,spline}</span>
<span class="sd">    verbose: int, default 0</span>
<span class="sd">        the verbosity level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;applywarp&quot;</span><span class="p">,</span>
           <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span>
           <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">,</span>
           <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span>
           <span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="n">warp_file</span><span class="p">,</span>
           <span class="s2">&quot;--abs&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--interp=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interp</span><span class="p">),</span>
           <span class="s2">&quot;--verbose=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">verbose</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">pre_affine_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--premat=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_affine_file</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">post_affine_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--postmat=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">post_affine_file</span><span class="p">))</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="flirt2aff"><a class="viewcode-back" href="../../generated/limri.regtools.flirt2aff.html#limri.regtools.flirt2aff">[docs]</a><span class="k">def</span> <span class="nf">flirt2aff</span><span class="p">(</span><span class="n">mat_file</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Map from &#39;in_file&#39; image voxels to &#39;ref_file&#39; voxels given `mat_file`</span>
<span class="sd">    omat FSL affine transformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    mat_file: str</span>
<span class="sd">        filename of output &#39;-omat&#39; transformation file from FSL flirt.</span>
<span class="sd">    in_file: str</span>
<span class="sd">        filename of the image passed to flirt as the &#39;-in&#39; image.</span>
<span class="sd">    ref_file: str</span>
<span class="sd">        filename of the image passed to flirt as the &#39;-ref&#39; image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    omat: array (4, 4)</span>
<span class="sd">        array containing the transform from voxel coordinates in image</span>
<span class="sd">        for &#39;in_file&#39; to voxel coordinates in image for &#39;ref_file&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flirt_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mat_file</span><span class="p">)</span>
    <span class="n">in_img</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
    <span class="n">ref_img</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span>
    <span class="n">in_hdr</span> <span class="o">=</span> <span class="n">in_img</span><span class="o">.</span><span class="n">header</span>
    <span class="n">ref_hdr</span> <span class="o">=</span> <span class="n">ref_img</span><span class="o">.</span><span class="n">header</span>

    <span class="k">def</span> <span class="nf">_x_flipper</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">flipr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">flipr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">flipr</span>

    <span class="n">inspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">in_hdr</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">refspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">ref_hdr</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">in_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">inspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">inspace</span><span class="p">,</span> <span class="n">_x_flipper</span><span class="p">(</span><span class="n">in_hdr</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">ref_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">refspace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">refspace</span><span class="p">,</span> <span class="n">_x_flipper</span><span class="p">(</span><span class="n">ref_hdr</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">omat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">refspace</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">flirt_affine</span><span class="p">,</span> <span class="n">inspace</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">omat</span></div>


<div class="viewcode-block" id="normalize2field"><a class="viewcode-back" href="../../generated/limri.regtools.normalize2field.html#limri.regtools.normalize2field">[docs]</a><span class="k">def</span> <span class="nf">normalize2field</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Transform a SPM normalization field to a FSL field.</span>

<span class="sd">    For the deformation fields generated in SPM, the values in each of the</span>
<span class="sd">    three components (ie (:,:,:,1,1), (:,:,:,1,2) and (:,:,:,1,3) ) encode</span>
<span class="sd">    the x,y,z coordinates of the corresponding location (in units of mm).</span>

<span class="sd">    SPM conventions:</span>
<span class="sd">    1) The file encodes the mapping rather than displacement fields for a</span>
<span class="sd">    couple of reasons:</span>
<span class="sd">    a) Even in 2012, many people still seem to think that displacements</span>
<span class="sd">    can be combined by addition or subtraction, rather than by composing</span>
<span class="sd">    or inverting the mappings.  (Attempting to compose deformations by</span>
<span class="sd">    adding the displacement fields would be analogous to saying 2*2=3 or</span>
<span class="sd">    3*3=5). Using the mapping instead of the displacements would (I hope)</span>
<span class="sd">    make this abuse a bit less likely.</span>
<span class="sd">    b) It saves needing to encode an additional affine transform matrix</span>
<span class="sd">    for dealing with the identity transform to which the displacements are</span>
<span class="sd">    added. This makes life simpler.</span>
<span class="sd">    2) It encodes coordinates in mm, rather than voxels. If the mapping</span>
<span class="sd">    was to voxels, it would not work so well for images that are in</span>
<span class="sd">    alignment via the matrices encoded by the sform or qform fields.</span>
<span class="sd">    Also, if the mapping is to voxels, the values would depend on whether</span>
<span class="sd">    the first voxel in the file is denoted as 1,1,1 (as in MATLAB, Fortran</span>
<span class="sd">    or SPM) or as 0,0,0 (as in C or FSL). The mm coordinates are</span>
<span class="sd">    unambiguous - providing the sform (or sform) fields of the image that</span>
<span class="sd">    the deformation points to is filled in.</span>

<span class="sd">    The bad news here is that you do need to use the sform (qform)</span>
<span class="sd">    information to convert from SPM to FSL conventions. In FSL we can use</span>
<span class="sd">    either absolute coordinates (as is used in SPM) or relative ones.</span>
<span class="sd">    However, our mm coordinate system is not the same, so you&#39;ll need to map</span>
<span class="sd">    between FSL&#39;s and SPM&#39;s if you want to get the warp correct.</span>

<span class="sd">    The problem you are experiencing will be about coordinate system</span>
<span class="sd">    conventions. Our mm coordinate system is just a scalar multiple of the</span>
<span class="sd">    voxel coordinates if the image has a negative sform (or qform)</span>
<span class="sd">    determinant. If the determinant of the sform (or qform) matrix is</span>
<span class="sd">    positive then is it the same except that the x-voxel-coordinate is</span>
<span class="sd">    flipped first (0 to N-1 becomes N-1 to 0). Note that this means that</span>
<span class="sd">    our origin is in the 0,0,0 voxel (the centre of the voxel) and that we</span>
<span class="sd">    do not use the qform or sform information (except for the sign of the</span>
<span class="sd">    determinant). If you can figure out what the SPM conventions are then you</span>
<span class="sd">    should be able to adjust for this, although it may not be easy.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    https://github.com/nipy/nitransforms</span>
<span class="sd">    https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=fsl;ed6a4473.1208</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="antsregister"><a class="viewcode-back" href="../../generated/limri.regtools.antsregister.html#limri.regtools.antsregister">[docs]</a><span class="k">def</span> <span class="nf">antsregister</span><span class="p">(</span><span class="n">template_file</span><span class="p">,</span> <span class="n">li_file</span><span class="p">,</span> <span class="n">lianat_file</span><span class="p">,</span> <span class="n">hanat_file</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span>
                 <span class="n">mask_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compute the deformation field with Ants from a T1w image to a template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ants</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You will need to install AntsPy to execute this &quot;</span>
                          <span class="s2">&quot;function.&quot;</span><span class="p">)</span>

    <span class="n">print_subtitle</span><span class="p">(</span><span class="s2">&quot;Load data...&quot;</span><span class="p">)</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">li_file</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;li spacing: </span><span class="si">{</span><span class="n">li</span><span class="o">.</span><span class="n">spacing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;li origin: </span><span class="si">{</span><span class="n">li</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;li direction: </span><span class="si">{</span><span class="n">li</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;li.png&quot;</span><span class="p">)</span>
    <span class="n">li</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">lianat</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">lianat_file</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lianat spacing: </span><span class="si">{</span><span class="n">lianat</span><span class="o">.</span><span class="n">spacing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lianat origin: </span><span class="si">{</span><span class="n">lianat</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lianat direction: </span><span class="si">{</span><span class="n">lianat</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;lianat.png&quot;</span><span class="p">)</span>
    <span class="n">lianat</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;lianat&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">hanat</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">hanat_file</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hanat spacing: </span><span class="si">{</span><span class="n">hanat</span><span class="o">.</span><span class="n">spacing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hanat origin: </span><span class="si">{</span><span class="n">hanat</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hanat direction: </span><span class="si">{</span><span class="n">hanat</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;hanat.png&quot;</span><span class="p">)</span>
    <span class="n">hanat</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;hanat&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;template spacing: </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">spacing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;template origin: </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;template direction: </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;template.png&quot;</span><span class="p">)</span>
    <span class="n">template</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;template&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">print_subtitle</span><span class="p">(</span><span class="s2">&quot;Normalize...&quot;</span><span class="p">)</span>
    <span class="n">lianat</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath_normalize</span><span class="p">(</span><span class="n">lianat</span><span class="p">)</span>
    <span class="n">hanat</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath_normalize</span><span class="p">(</span><span class="n">hanat</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath_normalize</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

    <span class="n">print_subtitle</span><span class="p">(</span><span class="s2">&quot;Rigid: lianat -&gt; hanat...&quot;</span><span class="p">)</span>
    <span class="n">lianat2h</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">registration</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">lianat</span><span class="p">,</span> <span class="n">type_of_transform</span><span class="o">=</span><span class="s2">&quot;Rigid&quot;</span><span class="p">,</span>
        <span class="n">outprefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;lianat2h&quot;</span><span class="p">))</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rigid transforms: </span><span class="si">{</span><span class="n">lianat2h</span><span class="p">[</span><span class="s1">&#39;fwdtransforms&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">lianat2hanat</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">apply_transforms</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">lianat</span><span class="p">,</span> <span class="n">transformlist</span><span class="o">=</span><span class="n">lianat2h</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">],</span>
        <span class="n">interpolator</span><span class="o">=</span><span class="s2">&quot;bSpline&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;lianat2hanat.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">lianat2hanat</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lianat2h T1: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;lianat2hanat.png&quot;</span><span class="p">)</span>
    <span class="n">lianat2hanat</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">hanat</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;lianat2hanat&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">li2hanat</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">apply_transforms</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">li</span><span class="p">,</span> <span class="n">transformlist</span><span class="o">=</span><span class="n">lianat2h</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">],</span>
        <span class="n">interpolator</span><span class="o">=</span><span class="s2">&quot;bSpline&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;li2hanat.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">li2hanat</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;li2h T1: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;li2hanat.png&quot;</span><span class="p">)</span>
    <span class="n">li2hanat</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">hanat</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;li2hanat&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">print_subtitle</span><span class="p">(</span><span class="s2">&quot;Rigid + Affine + deformation field: hanat -&gt; template...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h2mni</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">registration</span><span class="p">(</span>
            <span class="n">fixed</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">type_of_transform</span><span class="o">=</span><span class="s2">&quot;SyNRA&quot;</span><span class="p">,</span>
            <span class="n">outprefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;h2mni&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h2mni</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">registration</span><span class="p">(</span>
            <span class="n">fixed</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">type_of_transform</span><span class="o">=</span><span class="s2">&quot;Affine&quot;</span><span class="p">,</span>
            <span class="n">outprefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;_h2mni&quot;</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span>
        <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mask spacing: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">spacing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mask origin: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mask direction: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">h2mni</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">registration</span><span class="p">(</span>
            <span class="n">fixed</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">type_of_transform</span><span class="o">=</span><span class="s2">&quot;SyNOnly&quot;</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">initial_transform</span><span class="o">=</span><span class="n">h2mni</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">outprefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;h2mni&quot;</span><span class="p">))</span>

    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deform transforms: </span><span class="si">{</span><span class="n">h2mni</span><span class="p">[</span><span class="s1">&#39;fwdtransforms&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">create_jacobian_determinant_image</span><span class="p">(</span>
        <span class="n">domain_image</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">h2mni</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">jac</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">hanat2mni</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">apply_transforms</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">hanat</span><span class="p">,</span> <span class="n">transformlist</span><span class="o">=</span><span class="n">h2mni</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">],</span>
        <span class="n">interpolator</span><span class="o">=</span><span class="s2">&quot;bSpline&quot;</span><span class="p">)</span>
    <span class="n">h2mnijac</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">apply_transforms</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> <span class="n">transformlist</span><span class="o">=</span><span class="n">h2mni</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">],</span>
        <span class="n">interpolator</span><span class="o">=</span><span class="s2">&quot;bSpline&quot;</span><span class="p">)</span>
    <span class="n">lianat2mni</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">apply_transforms</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">lianat</span><span class="p">,</span> <span class="n">interpolator</span><span class="o">=</span><span class="s2">&quot;bSpline&quot;</span><span class="p">,</span>
        <span class="n">transformlist</span><span class="o">=</span><span class="n">h2mni</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lianat2h</span><span class="p">[</span><span class="s2">&quot;fwdtransforms&quot;</span><span class="p">])</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;hjac.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">jac</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;h jacobian: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;h2mnijac.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">h2mnijac</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;h2mni jacobian: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;lianat2mni.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">lianat2mni</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;li2mni T1: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;hanat2mni.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">hanat2mni</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;h2mni T1: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;lianat2mni.png&quot;</span><span class="p">)</span>
    <span class="n">lianat2mni</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">template</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;lianat2mni&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;hanat2mni.png&quot;</span><span class="p">)</span>
    <span class="n">hanat2mni</span><span class="o">.</span><span class="n">plot_ortho</span><span class="p">(</span>
        <span class="n">template</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xyz_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orient_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;hanat2mni&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="apply_transforms"><a class="viewcode-back" href="../../generated/limri.regtools.apply_transforms.html#limri.regtools.apply_transforms">[docs]</a><span class="k">def</span> <span class="nf">apply_transforms</span><span class="p">(</span><span class="n">fixed_file</span><span class="p">,</span> <span class="n">moving_file</span><span class="p">,</span> <span class="n">transformlist</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Apply a transform list to map an image from one domain to another.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fixed_file: str</span>
<span class="sd">        fixed image defining domain into which the moving image is transformed.</span>
<span class="sd">    moving_file: str</span>
<span class="sd">        moving image to be mapped to fixed space.</span>
<span class="sd">    transformlist: list of str</span>
<span class="sd">        list of transforms generated by ants.registration where each transform</span>
<span class="sd">        is a filename.</span>
<span class="sd">    filename: str</span>
<span class="sd">        the name of the transformed image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ants</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You will need to install AntsPy to execute this &quot;</span>
                          <span class="s2">&quot;function.&quot;</span><span class="p">)</span>

    <span class="n">fixed</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">fixed_file</span><span class="p">)</span>
    <span class="n">moving</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="n">moving_file</span><span class="p">)</span>
    <span class="n">li2mni</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">apply_transforms</span><span class="p">(</span>
        <span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span><span class="o">=</span><span class="n">moving</span><span class="p">,</span> <span class="n">interpolator</span><span class="o">=</span><span class="s2">&quot;bSpline&quot;</span><span class="p">,</span>
        <span class="n">transformlist</span><span class="o">=</span><span class="n">transformlist</span><span class="p">)</span>
    <span class="n">li2mni</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="apply_translation"><a class="viewcode-back" href="../../generated/limri.regtools.apply_translation.html#limri.regtools.apply_translation">[docs]</a><span class="k">def</span> <span class="nf">apply_translation</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Apply a translation to an image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_file: str</span>
<span class="sd">        input image.</span>
<span class="sd">    translation: 3-uplet</span>
<span class="sd">        the translation in mm.</span>
<span class="sd">    filename: str</span>
<span class="sd">        the name of the transformed image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
    <span class="n">affine</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">affine</span>
    <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">translation</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span> <span class="n">affine</span><span class="p">)</span>
    <span class="n">nibabel</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_translation"><a class="viewcode-back" href="../../generated/limri.regtools.save_translation.html#limri.regtools.save_translation">[docs]</a><span class="k">def</span> <span class="nf">save_translation</span><span class="p">(</span><span class="n">translation</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Save a translation in Ants format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    translation: 3-uplet</span>
<span class="sd">        the translation in mm.</span>
<span class="sd">    filename: str</span>
<span class="sd">        the name of the transformed image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ants</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;You will need to install AntsPy to execute this &quot;</span>
                          <span class="s2">&quot;function.&quot;</span><span class="p">)</span>

    <span class="n">ras2lps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">create_ants_transform</span><span class="p">(</span>
        <span class="n">transform_type</span><span class="o">=</span><span class="s2">&quot;AffineTransform&quot;</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="p">(</span><span class="n">ras2lps</span> <span class="o">*</span> <span class="n">translation</span><span class="p">))</span>
    <span class="n">ants</span><span class="o">.</span><span class="n">write_transform</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="ants2affine"><a class="viewcode-back" href="../../generated/limri.regtools.ants2affine.html#limri.regtools.ants2affine">[docs]</a><span class="k">def</span> <span class="nf">ants2affine</span><span class="p">(</span><span class="n">mat_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Map from &#39;in_file&#39; image voxels to &#39;ref_file&#39; voxels given `mat_file`</span>
<span class="sd">    omat Ants affine transformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    mat_file: str</span>
<span class="sd">        filename of affine transformation file from Ants.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    omat: array (4, 4)</span>
<span class="sd">        array containing the transform from voxel coordinates in image</span>
<span class="sd">        for &#39;in_file&#39; to voxel coordinates in image for &#39;ref_file&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transfo_dict</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">mat_file</span><span class="p">)</span>
    <span class="n">lps2ras</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transfo_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;fixed&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">transfo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">transfo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">9</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">transfo_dict</span><span class="p">[</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span>
    <span class="n">r_trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">trans</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">omat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">omat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_trans</span>
    <span class="n">omat</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lps2ras</span><span class="p">,</span> <span class="n">rot</span><span class="p">),</span> <span class="n">lps2ras</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">omat</span></div>
</pre></div>
                    </div>
                <div class="spacer"></div>
		        
		        <!-- Footer -->
		        <div class="section-6-container section-container section-container-image-bg" id="section-6">
			        <div class="container">
			            <div class="row">
		                    <div class="col-md-5 offset-md-1 section-6-box wow fadeInDown">
                                <div class="section-6-title">
		                    	    <p>Follow us</p>
                                </div>
		                    	<div class="section-6-social">
			                    	<a href="https://www.facebook.com/pages/NeuroSpin/171075046414933"><i class="fab fa-facebook-f"></i></a>
									<a href="https://www.youtube.com/CEASaclay"><i class="fab fa-youtube"></i></a>
									<a href="https://twitter.com/neurospin_91"><i class="fab fa-twitter"></i></a>
									<a href="https://github.com/AGrigis/pysphinxdoc"><i class="fab fa-github"></i></a>
                                    <p>&copy; 2024, 
Limri developers
 <antoine.grigis@cea.fr></p>
		                    	</div>
		                    </div>
			            </div>
			        </div>
                </div>
	        
	        </div>
	        <!-- End content -->
        
        </div>
        <!-- End wrapper -->

        <!-- Javascript -->
		<script src="../../_static/js/jquery-3.3.1.min.js"></script>
		<script src="../../_static/js/jquery-migrate-3.0.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="../../_static/js/jquery.backstretch.min.js"></script>
        <script src="../../_static/js/wow.min.js"></script>
        <script src="../../_static/js/jquery.waypoints.min.js"></script>
        <script src="../../_static/js/jquery.mCustomScrollbar.concat.min.js"></script>
        <script src="../../_static/js/scripts.js"></script>
        <script src="../../_static/js/jquery.mosaic.js"></script>
        <script src="../../_static/js/search.js"></script>
        <script type="text/javascript">
	        $('.top-content').backstretch("../../_static/img/backgrounds/banner1.png");
            $('.section-6-container').backstretch("../../_static/img/backgrounds/footer1.png");
        </script>

    </body>

</html>